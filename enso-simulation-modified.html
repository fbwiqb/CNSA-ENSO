<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ENSO 시뮬레이션 - 엘니뇨와 라니냐</title>
    
    <!-- jQuery and jQuery UI -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    
    <!-- Phaser 2 CE -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser-ce/2.19.2/phaser.min.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', 'Malgun Gothic', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
            max-width: 1140px;
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        
        #interactive-container {
            width: 1080px;
            height: 700px;
            margin: 0 auto 20px;
            border: 2px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .slider-container {
            margin: 20px 0;
        }
        
        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        #wind-speed {
            width: 100%;
            margin: 20px 0;
        }
        
        .ui-slider {
            background: linear-gradient(to right, #3498db 0%, #95a5a6 50%, #e74c3c 100%);
            height: 10px;
            border-radius: 5px;
        }
        
        .ui-slider-handle {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            border: 2px solid #333;
            cursor: pointer;
            top: -5px;
        }
        
        .info-panel {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 20px;
        }
        
        .info-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .info-card h3 {
            color: #2c3e50;
            margin: 0 0 10px 0;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        #wind-speed-label, #condition-label {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 10px;
        }
        
        #condition-description {
            color: #666;
            line-height: 1.6;
            min-height: 80px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🌊 ENSO 시뮬레이션 - 엘니뇨 & 라니냐</h1>
        
        <div id="interactive-container"></div>
        
        <div class="controls">
            <div class="slider-container">
                <div class="slider-label">
                    <span>← 엘니뇨 (약한 무역풍)</span>
                    <span>정상</span>
                    <span>라니냐 (강한 무역풍) →</span>
                </div>
                <div id="wind-speed"></div>
            </div>
            
            <div class="info-panel">
                <div class="info-card">
                    <h3>무역풍 속도</h3>
                    <div id="wind-speed-label"><span>보통</span></div>
                </div>
                <div class="info-card">
                    <h3>상태</h3>
                    <div id="condition-label"><span>중립</span></div>
                </div>
            </div>
            
            <div class="info-card" style="margin-top: 20px;">
                <h3>설명</h3>
                <div id="condition-description">적도 태평양에서 엘니뇨나 라니냐가 발생하지 않은 정상 상태입니다.</div>
            </div>
        </div>
    </div>

    <script>
        // WX_P namespace simulation
        var WX_P = {
            basew: 1080,
            baseh: 700,
            interactiveStates: {},
            configure: function(state) {
                state.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;
                state.scale.pageAlignHorizontally = true;
                state.scale.pageAlignVertically = true;
            },
            popResize: function(state) {
                // Handle resize
            },
            init: function(containerId, width, height) {
                this.basew = width;
                this.baseh = height;
                
                // Initialize Phaser with error handling
                try {
                    var game = new Phaser.Game(width, height, Phaser.AUTO, containerId, null, false, false);
                    
                    // Add states
                    game.state.add('Boot', WX_P.interactiveStates.Boot);
                    game.state.add('Level_main', WX_P.interactiveStates.Level_main);
                    
                    // Start
                    game.state.start('Boot');
                } catch(e) {
                    console.error('Phaser initialization error:', e);
                    alert('시뮬레이션 로딩 중 오류가 발생했습니다. 콘솔을 확인해주세요.');
                }
            }
        };

        // Boot State
        WX_P.interactiveStates.Boot = function(game) {};
        WX_P.interactiveStates.Boot.prototype = {
            init: function() {
                WX_P.configure(this);
                // Set crossOrigin for images
                this.load.crossOrigin = 'anonymous';
            },
            preload: function() {
                this.stage.backgroundColor = '#000000';
                
                // Enable CORS for images
                this.load.crossOrigin = 'anonymous';
                
                // Load all images from GitHub Pages
                var baseURL = 'https://fbwiqb.github.io/enso-simulation/images/';
                
                this.load.image('arrow_head', baseURL + 'arrow_head.png');
                this.load.image('arrow_head_y', baseURL + 'arrow_head_y.png');
                this.load.image('text_overlay', baseURL + 'text_overlay.png');
                this.load.image('ocean', baseURL + 'ocean.png');
                this.load.image('land', baseURL + 'land.png');
                this.load.image('thermocline', baseURL + 'thermo.png');  // Using thermo.png
                this.load.image('warm_water', baseURL + 'warm_water.png');
                this.load.image('warm_water_2', baseURL + 'warm_water_2.png');
                this.load.image('arrow', baseURL + 'arrow.png');
                this.load.image('warm_water_label', baseURL + 'warm_water_label.png');
                // Removed westerly_winds_label loading
                
                // Spritesheets
                this.load.spritesheet('clouds', baseURL + 'clouds.png', 240, 224, 5);
                this.load.spritesheet('precipitation', baseURL + 'precipitation.png', 20, 20, 4);
                
                // Add error handling for image loading
                this.load.onFileError.add(function(key) {
                    console.error('Failed to load:', key);
                });
                
                // Add loading complete handler
                this.load.onLoadComplete.add(function() {
                    console.log('All assets loaded successfully!');
                });
            },
            create: function() {
                this.state.start('Level_main');
            },
            resize: function() {}
        };

        // Main State
        WX_P.interactiveStates.Level_main = function(game) {};
        WX_P.interactiveStates.Level_main.prototype = {
            create: function() {
                // Store reference
                _PS = this;
                
                // Backdrop
                this.stage.backgroundColor = '#A2E4FF';
                var ocean = this.add.sprite(0, 0, 'ocean');

                // Warm water sprites group
                this.warm_waters = this.add.group();
                this.warm_waters.cp = 0;
                this.warm_waters.create(150, 380, 'warm_water');
                this.warm_waters.create(150, 458, 'warm_water_2');
                
                // warm_water_label 크기 조정
                var warmWaterLabel = this.warm_waters.create(390, 490, 'warm_water_label');
                warmWaterLabel.scale.setTo(0.3, 0.3); // 30% 크기로 축소
                
                this.warm_waters.move = function(speed) {
                    var dx = speed * 5;
                    this.position.x = (this.cp - dx);
                };

                // Thermocline (using thermo.png)
                this.therm = this.add.sprite(0, 0, 'thermocline');
                this.therm.anchor.set(0.5, 0);
                this.therm.position.x = WX_P.basew / 2;
                this.therm.position.y = 500;
                this.therm.angle = -7;
                this.therm.cp = -7;
                // Ensure thermocline is visible
                this.therm.visible = true;
                this.therm.alpha = 1.0;
                // Add scale if needed
                this.therm.scale.setTo(0.3, 0.3);
                this.therm.move = function(speed) {
                    var dx = speed / 8;
                    this.angle = this.cp - dx;
                };

                // Land
                var land = this.add.sprite(0, 0, 'land');

                // jQuery UI Slider control
                this.$ctrl_windspeed = $('#wind-speed');
                this.$ctrl_windspeed.on("slide", function(event, ui) {
                    _PS.change(ui.value);
                });

                // Change handler
                this.change = function(speed) {
                    if (_PS.cycles && _PS.cycles.children) {
                        $(_PS.cycles.children).each(function(s, t) {
                            t.cpHandler(speed);
                        });
                    }
                    _PS.surfaceGroup.move(speed);
                    _PS.warm_waters.move(speed);
                    _PS.therm.move(speed);
                    _PS.$labels.change(speed);
                    _PS.upwelling.adjust(speed);
                }

                // Labels configuration - 한글화
                this.$labels = {
                    speedTypes: ['약함', '보통', '강함'],
                    conditionTypes: ['엘니뇨', '중립', '라니냐'],
                    conditionDesc: [
                        '엘리뇨는 무역풍의 약화로 태평양 적도 부근 해수면 온도가 평년보다 높아지는 현상으로, 동태평양에서는 강수량이 증가하고 서태평양에서는 가뭄이 나타납니다.',
                        '평상시는 동풍(무역풍)이 안정적으로 불어 따뜻한 해수가 서태평양으로 이동합니다. 동태평양에서는 용승으로 인한 차가운 해수가 공급으로 건조한 기후가 나타나고 서태평양에서는 따뜻한 해수로 인한 활발한 강수가 나타납니다.',
                        '라니냐는 무역풍이 강해져 태평양 적도 부근 해수면 온도가 평년보다 낮아지는 현상으로, 동태평양에서는 더욱 강한 용승과 이로인한 건조한 기후가 나타나고 서태평양에서는 평년보다 많은 강수량이 나타납니다.'
                    ],
                    $speed: $('#wind-speed-label span'),
                    $condition: $('#condition-label span'),
                    $descript: $('#condition-description'),
                    change: function(speed) {
                        var mod = Math.round(((speed + 50) / 50));
                        this.$speed.html(this.speedTypes[mod]);
                        this.$condition.html(this.conditionTypes[mod]);
                        this.$descript.html(this.conditionDesc[mod]);
                    }
                }

                // Graphics canvas for arrow cycles
                this.bmd = null;
                this.bmd = this.add.bitmapData(WX_P.basew, WX_P.baseh);
                this.bmd.addToWorld();

                // Array of arrow cycles
                this.cycles = {
                    children: []
                };

                // Arrow cycle class
                function arrowCycle(points, color, cpHandler, arrow_head) {
                    this.pathReset = true;
                    this.paused = false;
                    this.color = color;
                    this.cpHandler = cpHandler;
                    this.points = points;
                    this.pi = 0;

                    // Control points
                    this.cp = [
                        { x: this.points.x[0], y: this.points.y[0] },
                        { x: this.points.x[3], y: this.points.y[3] }
                    ];

                    // Generate interpolated path
                    this.createPath = function() {
                        this.path = [];
                        var x = 1 / 500;
                        var ix = 0;
                        for (var i = 0; i <= 1; i += x) {
                            var px = _PS.math.catmullRomInterpolation(this.points.x, i);
                            var py = _PS.math.catmullRomInterpolation(this.points.y, i);
                            var node = { x: px, y: py, angle: 0 };
                            if (ix > 0) {
                                node.angle = _PS.math.angleBetweenPoints(this.path[ix - 1], node);
                            }
                            this.path.push(node);
                            ix++;
                        }
                    }

                    // Add arrow sprite
                    arrow_head = arrow_head ? arrow_head : 'arrow_head';
                    this.arrow = _PS.add.sprite(0, 0, arrow_head);
                    this.arrow.anchor.set(0.5, 0.5);
                    // Set fixed scale for arrow sprites to prevent resizing
                    this.arrow.scale.setTo(1.0, 1.0);

                    // Draw function
                    this.draw = function() {
                        if (this.pathReset) {
                            this.createPath();
                            this.pathReset = false;
                        }
                        var pi = this.pi;
                        for (var i = 0; i < 100; i++) {
                            var pos = pi - i;
                            if (pos > 0 && pos < this.path.length) {
                                _PS.bmd.circle(this.path[pos].x, this.path[pos].y, 4, this.color);
                            }
                            if (pos < 0) {
                                var ov = this.path.length - Math.abs(pos);
                                _PS.bmd.circle(this.path[ov].x, this.path[ov].y, 4, this.color);
                            }
                        }
                        this.arrow.visible = true;
                        if (this.path[this.pi]) {
                            this.arrow.x = this.path[this.pi].x;
                            this.arrow.y = this.path[this.pi].y;
                            this.arrow.rotation = this.path[this.pi].angle;
                        }

                        this.pi += 1;
                        if (this.pi >= this.path.length) {
                            this.pi = 0;
                        }
                    }
                    _PS.cycles.children.push(this);
                }

                // Plot function
                this.plot = function() {
                    this.bmd.clear();
                    $(_PS.cycles.children).each(function(s, t) {
                        if (!t.paused) {
                            t.draw();
                        } else {
                            t.arrow.visible = false;
                        }
                    });
                }

                // Trade winds cycle
                var tradePoints = {
                    x: [390, 860, 880, 390, 390],
                    y: [102, 80, 370, 400, 102]
                };
                var tradeCpHandler = function(speed) {
                    var dx = speed * 5;
                    this.points.x[0] = (this.cp[0].x - dx);
                    this.points.x[4] = (this.cp[0].x - dx);
                    this.points.x[3] = (this.cp[1].x - dx);
                    this.pathReset = true;
                }
                this.tradeWinds = new arrowCycle(tradePoints, 'rgba(255,255,255,1)', tradeCpHandler);

                // Westerly winds cycle
                var westerlyPoints = {
                    x: [280, 80, 80, 280, 280],
                    y: [102, 102, 370, 400, 102]
                };
                var westerlyCpHandler = function(speed) {
                    var dx = speed * 5;
                    this.points.x[0] = (this.cp[0].x - dx);
                    this.points.x[4] = (this.cp[0].x - dx);
                    this.points.x[3] = (this.cp[1].x - dx);
                    this.pathReset = true;

                    if (speed > 23) {
                        this.paused = true;
                        // Removed westerly_winds_label visibility control
                    } else {
                        this.paused = false;
                        // Removed westerly_winds_label visibility control
                    }
                }
                this.westerlyWinds = new arrowCycle(westerlyPoints, 'rgba(255,255,255,1)', westerlyCpHandler);

                // Warm water cycle
                var warmPoints = {
                    x: [410, 867, 867, 410, 410],
                    y: [580, 512, 472, 487, 580]
                };
                var warmCpHandler = function(speed) {
                    var dx = speed * 3;
                    var dy = -speed;
                    this.points.x[0] = (this.cp[0].x - dx);
                    this.points.x[4] = (this.cp[0].x - dx);
                    this.points.y[0] = (this.cp[0].y - dy);
                    this.points.y[4] = (this.cp[0].y - dy);
                    this.points.x[3] = (this.cp[1].x - dx);
                    this.pathReset = true;
                }
                this.warmWater = new arrowCycle(warmPoints, 'rgba(240,235,36,1)', warmCpHandler, 'arrow_head_y');

                // Surface group (rain/clouds)
                this.surfaceGroup = this.add.group();
                this.surfaceGroup.cp = 0;
                this.surfaceGroup.move = function(speed) {
                    var dx = speed * 5;
                    this.position.x = (this.cp - dx);
                    _PS.clouds.move(speed);
                }

                // Precipitation emitter
                this.precipitation = this.add.emitter(0, 0, 400);
                this.precipitation.width = 200;
                this.precipitation.makeParticles('precipitation');
                this.precipitation.minParticleScale = 0.5;
                this.precipitation.maxParticleScale = 0.8;
                this.precipitation.setYSpeed(100, 200);
                this.precipitation.setXSpeed(80, 80);
                this.precipitation.minRotation = 0;
                this.precipitation.maxRotation = 0;
                this.precipitation.frame = 1;
                this.rain = function() {
                    _PS.precipitation.position.x = _PS.clouds.position.x + 140;
                    _PS.precipitation.position.y = _PS.clouds.position.y + _PS.clouds.height;
                    _PS.precipitation.start(false, 250, 10, 0);
                };
                this.surfaceGroup.add(this.precipitation);

                // Clouds
                this.clouds = this.add.sprite(190, 130, 'clouds');
                this.clouds.animations.add('accumulate');
                this.clouds.events.onAnimationComplete.add(this.rain);
                this.clouds.cp = this.clouds.position.x;
                this.clouds.accumulate = function() {
                    _PS.clouds.animations.stop(null, true);
                    _PS.clouds.animations.play('accumulate', 1, false);
                };
                this.clouds.move = function(speed) {
                    this.accumulate();
                    _PS.precipitation.on = false;
                }
                this.clouds.accumulate();
                this.surfaceGroup.add(this.clouds);

                // Upwelling
                this.upwelling = this.add.emitter(WX_P.basew - 180, WX_P.baseh - 115, 500);
                this.upwelling.width = 1;
                this.upwelling.makeParticles('arrow');
                this.upwelling.minParticleScale = 0.8;
                this.upwelling.maxParticleScale = 0.8;
                this.upwelling.setYSpeed(-20, -20);
                this.upwelling.setXSpeed(0, 0);
                this.upwelling.gravity = -8.9;
                this.upwelling.minRotation = 0;
                this.upwelling.maxRotation = 0;
                this.upwelling.start(false, 1000, 400, 0, 0);
                this.upwelling.cp = this.upwelling.position.y;
                this.upwelling.adjust = function(speed) {
                    var dx = speed / 10;
                    this.position.y = this.cp - speed;
                    this.setYSpeed(-30 - dx * 4, -30 - dx * 4);
                };

                // Removed westerly_winds_label sprite creation
                
                // Text overlays - 맨 마지막에 추가하여 최상단 레이어에 표시
                // text_overlay가 너무 크므로 매우 작게 축소
                this.text_overlay = this.add.sprite(WX_P.basew / 2, 0, 'text_overlay');
                this.text_overlay.anchor.set(0.5, 0);
                this.text_overlay.scale.setTo(0.29, 0.29); // 15% 크기로 대폭 축소 (3712px -> 약 550px)
                
                // Console utility
                c = this;
            },

            update: function() {
                this.plot();
            },

            resize: function() {
                WX_P.popResize(this);
            }
        };

        // Initialize on document ready instead of window load
        $(document).ready(function() {
            // Setup slider
            $("#wind-speed").slider({
                value: 0,
                min: -50,
                max: 50,
                step: 1
            });

            // Wait a bit for everything to load
            setTimeout(function() {
                WX_P.init('interactive-container', 1080, 700);
            }, 100);
        });
    </script>
</body>
</html>